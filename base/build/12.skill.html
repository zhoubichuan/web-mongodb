<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>索引 | MongoDB学习笔记</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="个人总结的vuepress学习技术文档-语法">
    <meta name="keywords" content="vuepress,最新技术文档,vuepress语法,markdown语法">
    
    <link rel="preload" href="/web-mongodb/assets/css/0.styles.1221baa7.css" as="style"><link rel="preload" href="/web-mongodb/assets/js/app.46953e00.js" as="script"><link rel="preload" href="/web-mongodb/assets/js/2.9c6df21b.js" as="script"><link rel="preload" href="/web-mongodb/assets/js/1.c7999b22.js" as="script"><link rel="preload" href="/web-mongodb/assets/js/29.6de9ee14.js" as="script"><link rel="preload" href="/web-mongodb/assets/js/19.3aa63867.js" as="script"><link rel="prefetch" href="/web-mongodb/assets/js/10.62935875.js"><link rel="prefetch" href="/web-mongodb/assets/js/11.0669fae1.js"><link rel="prefetch" href="/web-mongodb/assets/js/12.908037a8.js"><link rel="prefetch" href="/web-mongodb/assets/js/13.7d4249f0.js"><link rel="prefetch" href="/web-mongodb/assets/js/14.503c154e.js"><link rel="prefetch" href="/web-mongodb/assets/js/15.e940f298.js"><link rel="prefetch" href="/web-mongodb/assets/js/16.1641d976.js"><link rel="prefetch" href="/web-mongodb/assets/js/17.77cb064f.js"><link rel="prefetch" href="/web-mongodb/assets/js/18.b37cbc46.js"><link rel="prefetch" href="/web-mongodb/assets/js/20.d3bc44a7.js"><link rel="prefetch" href="/web-mongodb/assets/js/21.e85e9d90.js"><link rel="prefetch" href="/web-mongodb/assets/js/22.16e8f03b.js"><link rel="prefetch" href="/web-mongodb/assets/js/23.83664782.js"><link rel="prefetch" href="/web-mongodb/assets/js/24.cff610c9.js"><link rel="prefetch" href="/web-mongodb/assets/js/25.75ce52a8.js"><link rel="prefetch" href="/web-mongodb/assets/js/26.e7eab329.js"><link rel="prefetch" href="/web-mongodb/assets/js/27.ad4f56fc.js"><link rel="prefetch" href="/web-mongodb/assets/js/28.1da3b40c.js"><link rel="prefetch" href="/web-mongodb/assets/js/3.9f5ca14c.js"><link rel="prefetch" href="/web-mongodb/assets/js/30.4388d6f8.js"><link rel="prefetch" href="/web-mongodb/assets/js/31.4b12d086.js"><link rel="prefetch" href="/web-mongodb/assets/js/32.e56d6931.js"><link rel="prefetch" href="/web-mongodb/assets/js/33.d5e0eadc.js"><link rel="prefetch" href="/web-mongodb/assets/js/34.a5bdc1f9.js"><link rel="prefetch" href="/web-mongodb/assets/js/35.c083b277.js"><link rel="prefetch" href="/web-mongodb/assets/js/36.c6294bab.js"><link rel="prefetch" href="/web-mongodb/assets/js/37.49f99c82.js"><link rel="prefetch" href="/web-mongodb/assets/js/38.0207d117.js"><link rel="prefetch" href="/web-mongodb/assets/js/39.7b511e6e.js"><link rel="prefetch" href="/web-mongodb/assets/js/4.5a212b2d.js"><link rel="prefetch" href="/web-mongodb/assets/js/40.18d654bc.js"><link rel="prefetch" href="/web-mongodb/assets/js/41.0764eab4.js"><link rel="prefetch" href="/web-mongodb/assets/js/42.9221178b.js"><link rel="prefetch" href="/web-mongodb/assets/js/43.dd6fe239.js"><link rel="prefetch" href="/web-mongodb/assets/js/44.13ebe8a4.js"><link rel="prefetch" href="/web-mongodb/assets/js/45.4f2f4d8f.js"><link rel="prefetch" href="/web-mongodb/assets/js/46.eb602e13.js"><link rel="prefetch" href="/web-mongodb/assets/js/47.c022f1db.js"><link rel="prefetch" href="/web-mongodb/assets/js/48.490caa90.js"><link rel="prefetch" href="/web-mongodb/assets/js/49.0ea69b84.js"><link rel="prefetch" href="/web-mongodb/assets/js/5.70f6abfa.js"><link rel="prefetch" href="/web-mongodb/assets/js/50.ca6ccc3d.js"><link rel="prefetch" href="/web-mongodb/assets/js/51.0294c615.js"><link rel="prefetch" href="/web-mongodb/assets/js/52.4ee4b94e.js"><link rel="prefetch" href="/web-mongodb/assets/js/53.467778b3.js"><link rel="prefetch" href="/web-mongodb/assets/js/54.8b3d7f73.js"><link rel="prefetch" href="/web-mongodb/assets/js/55.dcba9f56.js"><link rel="prefetch" href="/web-mongodb/assets/js/56.464bacc2.js"><link rel="prefetch" href="/web-mongodb/assets/js/57.a6b884de.js"><link rel="prefetch" href="/web-mongodb/assets/js/6.48f2ca4a.js"><link rel="prefetch" href="/web-mongodb/assets/js/7.6c1e9806.js"><link rel="prefetch" href="/web-mongodb/assets/js/vendors~docsearch.39676dd9.js">
    <link rel="stylesheet" href="/web-mongodb/assets/css/0.styles.1221baa7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/web-mongodb/" class="home-link router-link-active"><!----> <span class="site-name">MongoDB学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础知识" class="dropdown-title"><span class="title">基础知识</span> <span class="arrow down"></span></button> <button type="button" aria-label="基础知识" class="mobile-dropdown-title"><span class="title">基础知识</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web-mongodb/base/build/1.index.html" class="nav-link">
  一.基础学习
</a></li><li class="dropdown-item"><!----> <a href="/web-mongodb/base/practice/1.index.html" class="nav-link">
  二.实战练习
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="高级知识" class="dropdown-title"><span class="title">高级知识</span> <span class="arrow down"></span></button> <button type="button" aria-label="高级知识" class="mobile-dropdown-title"><span class="title">高级知识</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web-mongodb/senior/use/1.index.html" class="nav-link">
  一.项目实战
</a></li><li class="dropdown-item"><!----> <a href="/web-mongodb/senior/typeScript/1.index.html" class="nav-link">
  二.其他
</a></li></ul></div></div> <a href="https://gitee.com/zhoubichuan/web-mongodb" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础知识" class="dropdown-title"><span class="title">基础知识</span> <span class="arrow down"></span></button> <button type="button" aria-label="基础知识" class="mobile-dropdown-title"><span class="title">基础知识</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web-mongodb/base/build/1.index.html" class="nav-link">
  一.基础学习
</a></li><li class="dropdown-item"><!----> <a href="/web-mongodb/base/practice/1.index.html" class="nav-link">
  二.实战练习
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="高级知识" class="dropdown-title"><span class="title">高级知识</span> <span class="arrow down"></span></button> <button type="button" aria-label="高级知识" class="mobile-dropdown-title"><span class="title">高级知识</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web-mongodb/senior/use/1.index.html" class="nav-link">
  一.项目实战
</a></li><li class="dropdown-item"><!----> <a href="/web-mongodb/senior/typeScript/1.index.html" class="nav-link">
  二.其他
</a></li></ul></div></div> <a href="https://gitee.com/zhoubichuan/web-mongodb" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/web-mongodb/base/build/1.index.html" class="sidebar-link">一.概要</a></li><li><a href="/web-mongodb/base/build/2.webpack.html" class="sidebar-link">二.安装方式</a></li><li><a href="/web-mongodb/base/build/3.file.html" class="sidebar-link">三.启动与连接</a></li><li><a href="/web-mongodb/base/build/4.single.html" class="sidebar-link">四.基本概念</a></li><li><a href="/web-mongodb/base/build/5.page.html" class="sidebar-link">五.数据库操作</a></li><li><a href="/web-mongodb/base/build/7.module.html" class="sidebar-link">六.集合操作</a></li><li><a href="/web-mongodb/base/build/8.project.html" class="sidebar-link">七.文档操作</a></li><li><a href="/web-mongodb/base/build/9.utils.html" class="sidebar-link">八.更新文档</a></li><li><a href="/web-mongodb/base/build/10.ui.html" class="sidebar-link">十.删除文档</a></li><li><a href="/web-mongodb/base/build/11.data.html" class="sidebar-link">导入导出数据</a></li><li><a href="/web-mongodb/base/build/12.skill.html" aria-current="page" class="active sidebar-link">索引</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web-mongodb/base/build/12.skill.html#索引" class="sidebar-link">索引</a></li><li class="sidebar-sub-header"><a href="/web-mongodb/base/build/12.skill.html#_1-建立索引" class="sidebar-link">1.建立索引</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web-mongodb/base/build/12.skill.html#_1-1-插入数据" class="sidebar-link">1.1 插入数据</a></li><li class="sidebar-sub-header"><a href="/web-mongodb/base/build/12.skill.html#_1-2-二维索引" class="sidebar-link">1.2 二维索引</a></li></ul></li></ul></li><li><a href="/web-mongodb/base/build/13.com.html" class="sidebar-link">主从复制</a></li><li><a href="/web-mongodb/base/build/14.data.html" class="sidebar-link">扩展 mongoose 模型</a></li><li><a href="/web-mongodb/base/build/15.api.html" class="sidebar-link">中间件</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="索引"><a href="#索引" class="header-anchor">#</a> 索引</h2> <div class="custom-block tip"><p class="custom-block-title">前言</p> <p>索引通常能够极大的提高查询的效率，如果没有索引，MongoDB 在读取数据时必须扫描集合中的每个文件并选取那些符合查询条件的记录。
这种扫描全集合的查询效率是非常低的，特别在处理大量的数据时，查询可以要花费几十秒甚至几分钟，这对网站的性能是非常致命的。
索引是特殊的数据结构，索引存储在一个易于遍历读取的数据集合中，索引是对数据库表中一列或多列的值进行排序的一种结构
mongoindex</p> <p>特殊的数据结构，按顺序保存文档中的一个或多个字段
使用索引，方便范围查询和匹配查询。</p></div> <h2 id="_1-建立索引"><a href="#_1-建立索引" class="header-anchor">#</a> 1.建立索引</h2> <h3 id="_1-1-插入数据"><a href="#_1-1-插入数据" class="header-anchor">#</a> 1.1 插入数据</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> students <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">300000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  students<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;小明&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> i<span class="token punctuation">,</span> <span class="token literal-property property">random</span><span class="token operator">:</span> i <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>students<span class="token punctuation">)</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">299999</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">explain</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// &quot;executionTimeMillis&quot; : 245,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="_1-1-2-创建匿名索引"><a href="#_1-1-2-创建匿名索引" class="header-anchor">#</a> 1.1.2 创建匿名索引</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">ensureIndex</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">299999</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">explain</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// &quot;executionTimeMillis&quot; : 7,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="_1-1-3-创建命名索引"><a href="#_1-1-3-创建命名索引" class="header-anchor">#</a> 1.1.3 创建命名索引</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">ensureIndex</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;namedIndex&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">getIndexes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//查看索引</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="_1-1-4-分析索引的执行过程"><a href="#_1-1-4-分析索引的执行过程" class="header-anchor">#</a> 1.1.4 分析索引的执行过程</h4> <p>MongoDB 提供了一个 explain 命令让我们获知系统如何处理查询请求。利用 explain 命令，我们可以很好地观察系统如何使用索引来加快检索，同时可以针对性优化索引。</p> <ul><li>cursor: 返回游标类型</li> <li>BasicCursor 而没有使用索引的查询并不是胡乱查询，而是使用了基本游标：，同理，</li> <li>使用索引的查询就是 BtreeCursor</li> <li>nscanned: 查找过的索引条目的数量</li> <li>n: 返回的文档数量</li> <li>nscannedObjects ：数据库按照索引去磁盘上查找实际文档的次数</li> <li>millis: 执行本次查询所花费的时间，以毫秒计算，这也是判断查询效率的一个重点</li> <li>indexBounds: 描述索引的使用情况</li> <li>isMultiKey:是否使用了多键索引</li> <li>scanAndOrder: 是否在内存中对结果进行了排序</li> <li>indexOnly:是否仅仅使用索引完成了本次查询</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;小明 150000&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">explain</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_1-1-5-指定使用的索引"><a href="#_1-1-5-指定使用的索引" class="header-anchor">#</a> 1.1.5 指定使用的索引</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>students
  <span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;小明 299999&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">299999</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">hint</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">explain</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="_1-1-6-创建唯一索引并删除重复记录"><a href="#_1-1-6-创建唯一索引并删除重复记录" class="header-anchor">#</a> 1.1.6 创建唯一索引并删除重复记录</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>person<span class="token punctuation">.</span><span class="token function">ensureIndex</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;indexname&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">unique</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">dropDups</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="_1-1-7-删除索引"><a href="#_1-1-7-删除索引" class="header-anchor">#</a> 1.1.7 删除索引</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">dropIndex</span><span class="token punctuation">(</span><span class="token string">&quot;namedIndex&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 删除指定的索引</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">dropIndex</span><span class="token punctuation">(</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">runCommand</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">dropIndexes</span><span class="token operator">:</span> <span class="token string">&quot;students&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token string">&quot;namedIndex&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 删除所有的索引</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_1-1-8-在后台创建索引"><a href="#_1-1-8-在后台创建索引" class="header-anchor">#</a> 1.1.8 在后台创建索引</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">ensureIndex</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;nameIndex&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">unique</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">background</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="_1-1-9-建立多键索引"><a href="#_1-1-9-建立多键索引" class="header-anchor">#</a> 1.1.9 建立多键索引</h4> <p>mongodb 可以自动对数组进行索引</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">hobby</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">'basketball'</span><span class="token punctuation">,</span><span class="token string">'football'</span><span class="token punctuation">,</span><span class="token string">'pingpang'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">ensureIndex</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">hobby</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">hobby</span><span class="token operator">:</span><span class="token string">'football'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">hobby</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>\_id<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">explain</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_1-1-10-复合索引"><a href="#_1-1-10-复合索引" class="header-anchor">#</a> 1.1.10 复合索引</h4> <p>查询的条件不止一个，需要用复合索引</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">ensureIndex</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token literal-property property">age</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token literal-property property">age</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token literal-property property">age</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>\_id<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">explain</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="_1-1-11-过期索引"><a href="#_1-1-11-过期索引" class="header-anchor">#</a> 1.1.11 过期索引</h4> <p>在一定的时间后会过期，过期后相应数据数据被删除,比如 session、日志、缓存和临时文件</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>db.stus.insert<span class="token punctuation">(</span><span class="token punctuation">{</span>time:new Date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
db.stus.ensureIndex<span class="token punctuation">(</span><span class="token punctuation">{</span>time:1<span class="token punctuation">}</span>,<span class="token punctuation">{</span>expireAfterSeconds:10<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
db.stus.find<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment"># 1.索引字段的值必须 Date 对象，不能是其它类型比如时间戳 2.删除时间不精确，每 60 秒跑一次。删除也要时间，所以有误差。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_1-1-12-全文索引"><a href="#_1-1-12-全文索引" class="header-anchor">#</a> 1.1.12 全文索引</h4> <p>大篇幅的文章中搜索关键词,MongoDB 为我们提供了全文索引</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>db.article.insert<span class="token punctuation">(</span><span class="token punctuation">{</span> content: <span class="token string">&quot;I am a gir&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
db.article.insert<span class="token punctuation">(</span><span class="token punctuation">{</span> content: <span class="token string">&quot;I am a boy&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>$text:表示要在全文索引中查东西</li> <li>$search:后边跟查找的内容, 默认全部匹配</li></ul> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>db.article.find<span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token variable">$text</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token variable">$search</span><span class="token builtin class-name">:</span> <span class="token string">&quot;boy&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
db.article.find<span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token variable">$text</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token variable">$search</span><span class="token builtin class-name">:</span> <span class="token string">&quot;girl&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
db.article.find<span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token variable">$text</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token variable">$search</span><span class="token builtin class-name">:</span> <span class="token string">&quot;boy girl&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment"># 多次查找，多个关键字为或的关系</span>
db.article.find<span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token variable">$text</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token variable">$search</span><span class="token builtin class-name">:</span> <span class="token string">&quot;a b&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
db.article.find<span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token variable">$text</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token variable">$search</span><span class="token builtin class-name">:</span> <span class="token string">&quot;boy -girl&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment"># - 表示取消</span>
db.article.find<span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token variable">$text</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token variable">$search</span><span class="token builtin class-name">:</span> <span class="token string">'a &quot;coco cola&quot; b '</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment"># 支持转义符的,用\斜杠来转义</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="_1-2-二维索引"><a href="#_1-2-二维索引" class="header-anchor">#</a> 1.2 二维索引</h3> <p>mongodb 提供强大的空间索引可以查询出一定落地的地理坐标</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token literal-property property">gis</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">x</span> <span class="token operator">:</span> <span class="token number">50</span> <span class="token punctuation">,</span> <span class="token literal-property property">y</span> <span class="token operator">:</span> <span class="token number">30</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_1-2-1-创建-2d-索引"><a href="#_1-2-1-创建-2d-索引" class="header-anchor">#</a> 1.2.1 创建 2D 索引</h4> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>db.maps.ensureIndex<span class="token punctuation">(</span><span class="token punctuation">{</span> gis: <span class="token string">&quot;2d&quot;</span> <span class="token punctuation">}</span>, <span class="token punctuation">{</span> min: <span class="token number">1</span>, max: <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>默认会创建一个 2D 索引</p> <h4 id="_1-2-2-查询出距离点-最近的-3-个点"><a href="#_1-2-2-查询出距离点-最近的-3-个点" class="header-anchor">#</a> 1.2.2 查询出距离点()最近的 3 个点</h4> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>db.maps.find<span class="token punctuation">(</span><span class="token punctuation">{</span> gis: <span class="token punctuation">{</span> <span class="token variable">$near</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token number">1</span>, <span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>.limit<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_1-2-3-查询以点-50-50-和点-190-190-为对角线的正方形中的所有的点"><a href="#_1-2-3-查询以点-50-50-和点-190-190-为对角线的正方形中的所有的点" class="header-anchor">#</a> 1.2.3 查询以点(50,50)和点(190,190)为对角线的正方形中的所有的点</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>map<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">gis</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">$within</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">$box</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>\_id<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token literal-property property">gis</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_1-2-4-查出以圆心为为半径为规则下圆心面积中的点"><a href="#_1-2-4-查出以圆心为为半径为规则下圆心面积中的点" class="header-anchor">#</a> 1.2.4 查出以圆心为为半径为规则下圆心面积中的点</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>maps<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">gis</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">$within</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">$center</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>\_id<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token literal-property property">gis</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_1-2-5-索引使用的注意事项"><a href="#_1-2-5-索引使用的注意事项" class="header-anchor">#</a> 1.2.5 索引使用的注意事项</h4> <ul><li>1 为正序 -1 为倒序</li> <li>索引虽然可以提升查询性能，但会降低插件性能，对于插入多查询少不要创索引</li> <li>数据量不大时不需要使用索引。性能的提升并不明显，反而大大增加了内存和硬盘的消耗。</li> <li>查询数据超过表数据量 30%时，不要使用索引字段查询</li> <li>排序工作的时候可以建立索引以提高排序速度</li> <li>数字索引，要比字符串索引快的多</li></ul> <h4 id="附录"><a href="#附录" class="header-anchor">#</a> 附录</h4> <h5 id="queryplanner-分析"><a href="#queryplanner-分析" class="header-anchor">#</a> queryPlanner 分析</h5> <ul><li>queryPlanner: queryPlanner 的返回</li> <li>queryPlanner.namespace:该值返回的是该 query 所查询的表</li> <li>queryPlanner.indexFilterSet:针对该 query 是否有 indexfilter</li> <li>queryPlanner.winningPlan:查询优化器针对该 query 所返回的最优执行计划的详细内容。</li> <li>queryPlanner.winningPlan.stage:最优执行计划的 stage，这里返回是 FETCH，可以理解为通过返回的 index 位置去检索具体的文档（stage 有数个模式，将在后文中进行详解）。</li> <li>queryPlanner.winningPlan.inputStage:用来描述子 stage，并且为其父 stage 提供文档和索引关键字。</li> <li>queryPlanner.winningPlan.stage 的 child stage，此处是 IXSCAN，表示进行的是 index scanning。</li> <li>queryPlanner.winningPlan.keyPattern:所扫描的 index 内容，此处是 did:1,status:1,modify_time: -1 与 scid : 1</li> <li>queryPlanner.winningPlan.indexName：winning plan 所选用的 index。</li> <li>queryPlanner.winningPlan.isMultiKey 是否是 Multikey，此处返回是 false，如果索引建立在 array 上，此处将是 true。</li> <li>queryPlanner.winningPlan.direction：此 query 的查询顺序，此处是 forward，如果用了.sort({modify_time:-1})将显示 backward。</li> <li>queryPlanner.winningPlan.indexBounds:winningplan 所扫描的索引范围,如果没有制定范围就是[MaxKey, MinKey]，这主要是直接定位到 mongodb 的 chunck 中去查找数据，加快数据读取。</li> <li>queryPlanner.rejectedPlans：其他执行计划（非最优而被查询优化器 reject 的）的详细返回，其中具体信息与 winningPlan 的返回中意义相同，故不在此赘述。</li></ul> <h5 id="对-executionstats-返回逐层分析"><a href="#对-executionstats-返回逐层分析" class="header-anchor">#</a> 对 executionStats 返回逐层分析</h5> <ul><li>第一层，executionTimeMillis</li> <li>最为直观 explain 返回值是 executionTimeMillis 值，指的是我们这条语句的执行时间，这个值当然是希望越少越好。</li> <li>其中有 3 个 executionTimeMillis，分别是：</li> <li>executionStats.executionTimeMillis 该 query 的整体查询时间。</li> <li>executionStats.executionStages.executionTimeMillisEstimate</li> <li>该查询根据 index 去检索 document 获得 2001 条数据的时间。</li> <li>executionStats.executionStages.inputStage.executionTimeMillisEstimate</li> <li>该查询扫描 2001 行 index 所用时间。
第二层，index 与 document 扫描数与查询返回条目数 这个主要讨论 3 个返回项，nReturned、totalKeysExamined、totalDocsExamined，分别代表该条查询返回的条目、索引扫描条目、文档扫描条目。 这些都是直观地影响到 executionTimeMillis，我们需要扫描- 的越少速度越快。 对于一个查询，我们最理想的状态是：nReturned=totalKeysExamined=totalDocsExamined</li> <li>第三层，stage 状态分析 那么又是什么影响到了 totalKeysExamined 和 totalDocsExamined？是 stage 的类型。类型列举如下：</li> <li>COLLSCAN：全表扫描</li> <li>IXSCAN：索引扫描</li> <li>FETCH：根据索引去检索指定 document</li> <li>SHARD_MERGE：将各个分片返回数据进行 merge</li> <li>SORT：表明在内存中进行了排序</li> <li>LIMIT：使用 limit 限制返回数</li> <li>SKIP：使用 skip 进行跳过</li> <li>IDHACK：针对_id 进行查询</li> <li>SHARDING_FILTER：通过 mongos 对分片数据进行查询</li> <li>COUNT：利用 db.coll.explain().count()之类进行 count 运算</li> <li>COUNTSCAN：count 不使用 Index 进行 count 时的 stage 返回</li> <li>COUNT_SCAN：count 使用了 Index 进行 count 时的 stage 返回</li> <li>SUBPLA：未使用到索引的$or 查询的 stage 返回</li> <li>TEXT：使用全文索引进行查询时候的 stage 返回</li> <li>PROJECTION：限定返回字段时候 stage 的返回</li> <li>对于普通查询，我希望看到 stage 的组合(查询的时候尽可能用上索引)：</li> <li>Fetch+IDHACK</li> <li>Fetch+ixscan</li> <li>Limit+（Fetch+ixscan）</li> <li>PROJECTION+ixscan</li> <li>SHARDING_FITER+ixscan</li> <li>COUNT_SCAN</li> <li>不希望看到包含如下的 stage：</li> <li></li> <li>COLLSCAN(全表扫描),SORT(使用 sort 但是无 index),不合理的 SKIP,SUBPLA(未用到 index 的$or),COUNTSCAN(不使用 index 进行 count)</li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://gitee.com/zhoubichuan/web-mongodb/edit/master/src/base/build/12.skill.md" target="_blank" rel="noopener noreferrer">在gitee上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2024/12/12 10:56:39</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/web-mongodb/base/build/11.data.html" class="prev">
        导入导出数据
      </a></span> <span class="next"><a href="/web-mongodb/base/build/13.com.html">
        主从复制
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/web-mongodb/assets/js/app.46953e00.js" defer></script><script src="/web-mongodb/assets/js/2.9c6df21b.js" defer></script><script src="/web-mongodb/assets/js/1.c7999b22.js" defer></script><script src="/web-mongodb/assets/js/29.6de9ee14.js" defer></script><script src="/web-mongodb/assets/js/19.3aa63867.js" defer></script>
  </body>
</html>
